<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒãƒ›ç”¨ æ¬å…¥ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ï¼ˆç¾å ´ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- ç”»åƒã‹ã‚‰æ–‡å­—ã‚’èª­ã‚€ãŸã‚ã®ãƒ–ãƒ©ã‚¦ã‚¶ç”¨OCRãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="top-nav">
    <a href="{{ url_for('index') }}">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a>
    <span>â€º</span>
    <span>ã‚¹ãƒãƒ›ç”¨ æ¬å…¥ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</span>
  </div>

  <div class="app">
    <div class="card">

      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="app-header">
        <div>
          <div class="app-title">
            ã‚¹ãƒãƒ›ç”¨ æ¬å…¥å…¥åŠ›
            <span class="app-title-badge">ç¾å ´å…¥åŠ›</span>
          </div>
          <div class="app-subtitle">
            ç¾å ´ã§é•·ã•ãƒ»é‡é‡ã‚’æ¸¬ã‚ŠãªãŒã‚‰ã€æ¬å…¥ç•ªå·ã”ã¨ã«ç°¡å˜ã«å…¥åŠ›ã§ãã‚‹ç”»é¢ã§ã™ã€‚
          </div>
          <div id="editingInfo" class="editing-info">
            æ¬å…¥ç•ªå·æœªé¸æŠ
          </div>
        </div>
      </div>

      <!-- æ¬å…¥ç•ªå·ï¼‹åŸºæœ¬èª¬æ˜ -->
      <div class="section">
        <div class="section-title">æ¬å…¥ç•ªå·</div>
        <div class="field-grid">
          <div class="field">
            <label for="hainyuId">æ¬å…¥ç•ªå·</label>
            <input
              type="text"
              id="hainyuId"
              placeholder="ä¾‹ï¼š2025-00123ï¼ˆæ–°è¦/æ—¢å­˜ã©ã¡ã‚‰ã‚‚OKï¼‰"
            />
            <div class="field-hint">
              ç¾å ´ã§å—ã‘å–ã£ãŸæ¬å…¥ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ—¢å­˜ãŒã‚ã‚Œã°è‡ªå‹•ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚
            </div>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button id="loadBtn" class="btn-secondary">èª­è¾¼ / æ–°è¦é–‹å§‹</button>
              <button id="toggleHelpBtn" class="btn-secondary btn-small">ï¼Ÿ ãƒ˜ãƒ«ãƒ—</button>
            </div>
          </div>
        </div>
        <div id="helpPanel" class="section-help" style="display:none;">
          <ul style="margin:0; padding-left:18px;">
            <li>æ¬å…¥ç•ªå·ã‚’å…¥åŠ›ã—ã¦ <strong>Enter</strong> ã¾ãŸã¯ã€Œèª­è¾¼ / æ–°è¦é–‹å§‹ã€ã‚’æŠ¼ã™ã¨èª­ã¿è¾¼ã¿ã¾ã™ã€‚</li>
            <li>æ—¢å­˜ç•ªå·ã®å ´åˆã¯éå»ã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚åˆã‚ã¦ã®ç•ªå·ãªã‚‰æ–°è¦ã¨ã—ã¦å…¥åŠ›ã§ãã¾ã™ã€‚</li>
            <li>èª­ã¿è¾¼ã‚“ã ã‚ã¨ã¯ã€ãã®æ¬å…¥ç•ªå·ã§æ˜ç´°ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰ã€Œã“ã®æ¬å…¥ç•ªå·ã§ä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
          </ul>
        </div>
      </div>

      <!-- åŸºæœ¬æƒ…å ± -->
      <div class="section">
        <div class="section-title">åŸºæœ¬æƒ…å ±</div>
        <div class="field-grid">
          <div class="field">
            <label for="dateInput">æ¬å…¥å¹´æœˆæ—¥</label>
            <input type="date" id="dateInput" />
          </div>
          <div class="field">
            <label for="shipperInput">è·ä¸»</label>
            <input type="text" id="shipperInput" placeholder="ä¾‹ï¼šâ—‹â—‹å•†äº‹æ ªå¼ä¼šç¤¾" />
          </div>
        </div>

        <div class="field-grid" style="margin-top:6px;">
          <div class="field">
            <label for="destInput">ä»•å‘ã‘åœ°</label>
            <input type="text" id="destInput" placeholder="ä¾‹ï¼šSINGAPORE / HARBOR A" />
          </div>
          <div class="field">
            <label for="itemNameInput">å“å</label>
            <input type="text" id="itemNameInput" placeholder="ä¾‹ï¼šæ©Ÿæ¢°éƒ¨å“ / è¡£é¡ / é£Ÿå“ ç­‰" />
          </div>
        </div>

        <!-- ãƒãƒ¼ã‚¯ + OCRãƒœã‚¿ãƒ³ -->
        <div class="field" style="margin-top:8px;">
          <label for="markInput">
            ãƒãƒ¼ã‚¯ï¼ˆè·å°ï¼‰
            <button type="button" id="markOcrBtn" class="btn-secondary btn-small btn-xs">
              ğŸ“· ç”»åƒã‹ã‚‰æ–‡å­—
            </button>
          </label>
          <textarea
            id="markInput"
            placeholder="ä¾‹ï¼š&#10;ABC / TOKYO&#10;LOT NO.1234&#10;MADE IN JAPAN"
          ></textarea>
          <!-- ã‚«ãƒ¡ãƒ©/ç”»åƒé¸æŠç”¨ inputï¼ˆéš ã—ï¼‰ -->
          <input
            type="file"
            id="markOcrFile"
            accept="image/*"
            capture="environment"
            style="display:none;"
          />
          <div class="field-hint">
            ğŸ“· ã‚’æŠ¼ã™ã¨ã‚«ãƒ¡ãƒ©ï¼ˆã¾ãŸã¯å†™çœŸï¼‰ã‚’é–‹ãã€æ’®å½±ã—ãŸãƒ©ãƒ™ãƒ«ãªã©ã‹ã‚‰æ–‡å­—ã‚’èª­ã¿å–ã£ã¦ãƒãƒ¼ã‚¯æ¬„ã«åæ˜ ã—ã¾ã™ã€‚
          </div>
        </div>
      </div>

      <!-- æ˜ç´°å…¥åŠ›ï¼ˆ1ä»¶ã¶ã‚“ï¼‰ -->
      <div class="section">
        <div class="section-title">
          æ˜ç´°å…¥åŠ›
          <span id="rowIndicator" style="font-size:11px; color:var(--text-sub); margin-left:8px;">
            æ–°è¦æ˜ç´°
          </span>
        </div>

        <div class="field">
          <label for="pkgInput">è·å§¿</label>
          <input
            type="text"
            id="pkgInput"
            placeholder="ä¾‹ï¼šæ®µãƒœãƒ¼ãƒ«ç®± / ãƒ‘ãƒ¬ãƒƒãƒˆ ç­‰"
          />
        </div>

        <div class="field-grid" style="margin-top:6px;">
          <div class="field">
            <label for="noFromInput">â„–é–‹å§‹</label>
            <input type="number" id="noFromInput" inputmode="numeric" />
          </div>
          <div class="field">
            <label for="noToInput">â„–çµ‚äº†</label>
            <input type="number" id="noToInput" inputmode="numeric" />
          </div>
          <div class="field">
            <label for="qtyInput">å€‹æ•°</label>
            <input type="number" id="qtyInput" inputmode="numeric" />
          </div>
        </div>
        <div class="field-hint" style="margin-top:4px;">
          ä¾‹ï¼‰â„–é–‹å§‹ã« <strong>1</strong>ã€â„–çµ‚äº†ã« <strong>10</strong> ã¨å…¥ã‚Œã‚‹ã¨ã€å€‹æ•°ã¯ <strong>10</strong> ã¨è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚ã©ã¡ã‚‰ã‹ç‰‡æ–¹ã ã‘ãªã‚‰å€‹æ•°ã¯ <strong>1</strong> ã«ãªã‚Šã¾ã™ã€‚
        </div>

        <div class="field-grid" style="margin-top:8px;">
          <div class="field">
            <label for="lenInput">L (cm)</label>
            <input type="number" id="lenInput" inputmode="decimal" />
          </div>
          <div class="field">
            <label for="widInput">W (cm)</label>
            <input type="number" id="widInput" inputmode="decimal" />
          </div>
          <div class="field">
            <label for="heiInput">H (cm)</label>
            <input type="number" id="heiInput" inputmode="decimal" />
          </div>
        </div>

        <div class="field-grid" style="margin-top:8px;">
          <div class="field">
            <label for="weightInput">é‡é‡ (kg/1å€‹)</label>
            <input type="number" id="weightInput" inputmode="decimal" />
          </div>
          <div class="field">
            <label for="m3Input">M3ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
            <input type="text" id="m3Input" readonly />
          </div>
        </div>
        <div class="field-hint" style="margin-top:4px;">
          M3 = å€‹æ•° Ã— L Ã— W Ã— H Ã— 0.000001ï¼ˆå°æ•°ç¬¬4ä½å››æ¨äº”å…¥ï¼‰ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
        </div>

        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
          <button id="rowClearBtn" class="btn-secondary btn-small">ã“ã®æ˜ç´°ã‚’ã‚¯ãƒªã‚¢</button>
          <button id="rowSaveBtn" class="btn-primary btn-small">æ˜ç´°ã‚’è¿½åŠ  / æ›´æ–°</button>
        </div>
      </div>

      <!-- æ˜ç´°ä¸€è¦§ -->
      <div class="section">
        <div class="section-title">ç™»éŒ²æ¸ˆã¿æ˜ç´°ä¸€è¦§</div>
        <div id="rowsList">
          <div class="table-note">ã¾ã æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        </div>
      </div>

      <!-- åˆè¨ˆï¼‹ä¿å­˜ -->
      <div class="section">
        <div class="footer-bar">
          <div class="footer-left">
            <div class="totals">
              <div>
                <div class="totals-label">ç· M3</div>
                <div class="totals-value">
                  <span id="totalM3">0.000</span><span> mÂ³</span>
                </div>
              </div>
              <div>
                <div class="totals-label">ç·é‡é‡</div>
                <div class="totals-value">
                  <span id="totalWeight">0.0</span><span> kg</span>
                </div>
              </div>
            </div>
          </div>
          <div>
            <button id="saveBtn" class="btn-primary" disabled>ã“ã®æ¬å…¥ç•ªå·ã§ä¿å­˜ã™ã‚‹</button>
          </div>
        </div>
        <div id="statusMsg" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    let currentHainyuId = null;
    let isDirty = false;
    let items = [];
    let currentIndex = null; // ç·¨é›†ä¸­æ˜ç´° indexï¼ˆæ–°è¦ã¯ nullï¼‰

    function todayString() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function setStatus(msg, type = "") {
      const el = document.getElementById("statusMsg");
      el.textContent = msg || "";
      el.classList.remove("ok", "warn");
      if (type) el.classList.add(type);
    }

    function updateEditingIndicator() {
      const el = document.getElementById("editingInfo");
      if (!currentHainyuId) {
        el.textContent = "æ¬å…¥ç•ªå·æœªé¸æŠ";
        el.className = "editing-info";
        return;
      }
      if (isDirty) {
        el.textContent = `ç·¨é›†ä¸­: ${currentHainyuId}ï¼ˆæœªä¿å­˜ã®å¤‰æ›´ã‚ã‚Šï¼‰`;
        el.className = "editing-info editing-info-dirty";
      } else {
        el.textContent = `ç·¨é›†ä¸­: ${currentHainyuId}ï¼ˆä¿å­˜æ¸ˆï¼‰`;
        el.className = "editing-info editing-info-saved";
      }
    }

    function markDirty() {
      if (!isDirty) {
        isDirty = true;
        updateEditingIndicator();
      }
    }

    function calcM3(qty, L, W, H) {
      const q = Number(qty) || 0;
      const l = Number(L) || 0;
      const w = Number(W) || 0;
      const h = Number(H) || 0;
      const raw = q * l * w * h * 0.000001;
      return Math.round(raw * 1000) / 1000;
    }

    async function apiLoadRecord(hainyuId) {
      const res = await fetch(`/api/hainyu/${encodeURIComponent(hainyuId)}`);
      if (res.status === 404) return null;
      if (!res.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
      return await res.json();
    }

    async function apiSaveRecord(hainyuId, record) {
      const res = await fetch(`/api/hainyu/${encodeURIComponent(hainyuId)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(record),
      });
      if (!res.ok) throw new Error("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      return await res.json();
    }

    // ===== æ˜ç´°é–¢ä¿‚ =====
    function updateTotals() {
      let totalM3 = 0;
      let totalWeight = 0;

      items.forEach((it) => {
        const m3 = Number(it.m3) || 0;
        const qty = Number(it.qty) || 0;
        const w = Number(it.weightKg) || 0;
        totalM3 += m3;
        totalWeight += qty * w;
      });

      document.getElementById("totalM3").textContent = totalM3.toFixed(3);
      document.getElementById("totalWeight").textContent = totalWeight.toFixed(1);
    }

    function clearRowForm() {
      currentIndex = null;
      document.getElementById("rowIndicator").textContent = "æ–°è¦æ˜ç´°";

      document.getElementById("pkgInput").value = "";
      document.getElementById("noFromInput").value = "";
      document.getElementById("noToInput").value = "";
      document.getElementById("qtyInput").value = "";
      document.getElementById("lenInput").value = "";
      document.getElementById("widInput").value = "";
      document.getElementById("heiInput").value = "";
      document.getElementById("weightInput").value = "";
      document.getElementById("m3Input").value = "";
    }

    function fillRowFormFromItem(index) {
      const it = items[index];
      currentIndex = index;
      document.getElementById("rowIndicator").textContent = `æ˜ç´° ${index + 1} ã‚’ç·¨é›†ä¸­`;

      document.getElementById("pkgInput").value = it.packageType || "";
      document.getElementById("noFromInput").value = it.noFrom ?? "";
      document.getElementById("noToInput").value = it.noTo ?? "";
      document.getElementById("qtyInput").value = it.qty ?? "";
      document.getElementById("lenInput").value = it.L ?? "";
      document.getElementById("widInput").value = it.W ?? "";
      document.getElementById("heiInput").value = it.H ?? "";
      document.getElementById("weightInput").value = it.weightKg ?? "";
      document.getElementById("m3Input").value =
        it.m3 != null ? Number(it.m3).toFixed(3) : "";
    }

    function collectRowForm() {
      const pkg = document.getElementById("pkgInput").value.trim();
      const noFrom = document.getElementById("noFromInput").value;
      const noTo = document.getElementById("noToInput").value;
      const qty = document.getElementById("qtyInput").value;
      const L = document.getElementById("lenInput").value;
      const W = document.getElementById("widInput").value;
      const H = document.getElementById("heiInput").value;
      const weight = document.getElementById("weightInput").value;
      const m3 = document.getElementById("m3Input").value;

      if (!pkg && !noFrom && !noTo && !qty && !L && !W && !H && !weight) {
        return null;
      }

      return {
        packageType: pkg,
        noFrom: noFrom !== "" ? Number(noFrom) : null,
        noTo: noTo !== "" ? Number(noTo) : null,
        qty: qty !== "" ? Number(qty) : null,
        L: L !== "" ? Number(L) : null,
        W: W !== "" ? Number(W) : null,
        H: H !== "" ? Number(H) : null,
        weightKg: weight !== "" ? Number(weight) : null,
        m3: m3 !== "" ? Number(m3) : 0,
      };
    }

    function renderRowsList() {
      const container = document.getElementById("rowsList");
      container.innerHTML = "";

      if (!items.length) {
        container.innerHTML = `<div class="table-note">ã¾ã æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      const table = document.createElement("table");
      table.className = "search-table";
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:36px;">#</th>
            <th>è·å§¿</th>
            <th>â„–</th>
            <th>å€‹æ•°</th>
            <th>LÃ—WÃ—H (cm)</th>
            <th>é‡é‡</th>
            <th>M3</th>
            <th style="width:90px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        const lineWeight =
          (Number(it.qty) || 0) * (Number(it.weightKg) || 0);

        tr.innerHTML = `
          <td class="td-center">${idx + 1}</td>
          <td class="text-left">${it.packageType || ""}</td>
          <td class="td-center">${
            it.noFrom != null ? it.noFrom : ""
          }ã€œ${it.noTo != null ? it.noTo : ""}</td>
          <td class="td-center">${it.qty ?? ""}</td>
          <td class="td-center">${it.L ?? ""}Ã—${it.W ?? ""}Ã—${it.H ?? ""}</td>
          <td class="td-right">
            ${(it.weightKg ?? "")} kg/å€‹
            <br><span style="font-size:11px; color:var(--text-sub);">åˆè¨ˆ ${lineWeight.toFixed(1)} kg</span>
          </td>
          <td class="td-right">${it.m3 != null ? Number(it.m3).toFixed(3) : ""}</td>
          <td class="td-center">
            <button class="btn-secondary btn-small" data-action="edit">ç·¨é›†</button>
            <button class="btn-danger btn-small" data-action="delete">å‰Šé™¤</button>
          </td>
        `;

        tr.querySelectorAll("button").forEach((btn) => {
          const action = btn.getAttribute("data-action");
          if (action === "edit") {
            btn.addEventListener("click", () => {
              fillRowFormFromItem(idx);
              window.scrollTo({ top: 0, behavior: "smooth" });
            });
          } else if (action === "delete") {
            btn.addEventListener("click", () => {
              items.splice(idx, 1);
              markDirty();
              renderRowsList();
              updateTotals();
              clearRowForm();
            });
          }
        });

        tbody.appendChild(tr);
      });

      container.appendChild(table);
    }

    function updateQtyFromNos() {
      const noFromEl = document.getElementById("noFromInput");
      const noToEl = document.getElementById("noToInput");
      const qtyEl = document.getElementById("qtyInput");

      const from = parseInt(noFromEl.value, 10);
      const to = parseInt(noToEl.value, 10);
      let q = qtyEl.value ? Number(qtyEl.value) : 0;

      if (!isNaN(from) && !isNaN(to)) {
        if (to >= from) {
          q = to - from + 1;
        } else {
          q = 0;
        }
      } else if (!isNaN(from) || !isNaN(to)) {
        q = 1;
      } else {
        return;
      }
      qtyEl.value = q || "";
    }

    function updateRowM3Field() {
      const qty = document.getElementById("qtyInput").value;
      const L = document.getElementById("lenInput").value;
      const W = document.getElementById("widInput").value;
      const H = document.getElementById("heiInput").value;
      const m3El = document.getElementById("m3Input");

      if (!qty && !L && !W && !H) {
        m3El.value = "";
        return;
      }
      const m3 = calcM3(qty, L, W, H);
      m3El.value = m3.toFixed(3);
    }

    // ===== ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± =====
    function renderHeader(header) {
      const dateInput = document.getElementById("dateInput");
      const shipperInput = document.getElementById("shipperInput");
      const destInput = document.getElementById("destInput");
      const itemNameInput = document.getElementById("itemNameInput");
      const markInput = document.getElementById("markInput");

      if (header) {
        dateInput.value = header.date || todayString();
        shipperInput.value = header.shipper || "";
        destInput.value = header.dest || "";
        itemNameInput.value = header.itemName || "";
        markInput.value = header.mark || "";
      } else {
        dateInput.value = todayString();
        shipperInput.value = "";
        destInput.value = "";
        itemNameInput.value = "";
        markInput.value = "";
      }
    }

    function collectHeader() {
      const dateInput = document.getElementById("dateInput");
      const shipperInput = document.getElementById("shipperInput");
      const destInput = document.getElementById("destInput");
      const itemNameInput = document.getElementById("itemNameInput");
      const markInput = document.getElementById("markInput");

      return {
        date: dateInput.value || null,
        shipper: shipperInput.value.trim() || "",
        dest: destInput.value.trim() || "",
        itemName: itemNameInput.value.trim() || "",
        mark: markInput.value,
      };
    }

    // ===== åˆæœŸåŒ– =====
    window.addEventListener("DOMContentLoaded", () => {
      const hainyuInput = document.getElementById("hainyuId");
      const loadBtn = document.getElementById("loadBtn");
      const saveBtn = document.getElementById("saveBtn");
      const toggleHelpBtn = document.getElementById("toggleHelpBtn");
      const helpPanel = document.getElementById("helpPanel");

      const dateInput = document.getElementById("dateInput");
      const shipperInput = document.getElementById("shipperInput");
      const destInput = document.getElementById("destInput");
      const itemNameInput = document.getElementById("itemNameInput");
      const markInput = document.getElementById("markInput");
      const markOcrBtn = document.getElementById("markOcrBtn");
      const markOcrFile = document.getElementById("markOcrFile");

      // åˆæœŸå€¤
      dateInput.value = todayString();
      renderHeader(null);
      items = [];
      renderRowsList();
      updateTotals();
      updateEditingIndicator();

      // ãƒ˜ãƒ«ãƒ—é–‹é–‰
      toggleHelpBtn.addEventListener("click", () => {
        const visible = helpPanel.style.display !== "none";
        helpPanel.style.display = visible ? "none" : "block";
        toggleHelpBtn.textContent = visible ? "ï¼Ÿ ãƒ˜ãƒ«ãƒ—" : "Ã— é–‰ã˜ã‚‹";
      });

      // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ã§ dirty
      [dateInput, shipperInput, destInput, itemNameInput, markInput].forEach(
        (el) => {
          el.addEventListener("input", markDirty);
        }
      );

      // ãƒãƒ¼ã‚¯ç”¨ OCRï¼šãƒœã‚¿ãƒ³ â†’ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
      markOcrBtn.addEventListener("click", () => {
        markOcrFile.click();
      });

      // ãƒãƒ¼ã‚¯ç”¨ OCRï¼šç”»åƒé¸æŠå¾Œã«æ–‡å­—èªè­˜
      markOcrFile.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          setStatus("ç”»åƒã‹ã‚‰æ–‡å­—ã‚’èª­ã¿å–ã‚Šä¸­ã§ã™â€¦", "");
          const result = await Tesseract.recognize(file, "jpn+eng", {
            logger: (m) => console.log(m),
          });

          const text = (result.data && result.data.text) ? result.data.text.trim() : "";
          if (!text) {
            setStatus("ç”»åƒã‹ã‚‰æ–‡å­—ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", "warn");
            return;
          }

          if (markInput.value) {
            markInput.value = markInput.value.replace(/\s*$/, "") + "\n" + text;
          } else {
            markInput.value = text;
          }

          markDirty();
          setStatus("ç”»åƒã‹ã‚‰èª­ã¿å–ã£ãŸæ–‡å­—ã‚’ãƒãƒ¼ã‚¯ã«åæ˜ ã—ã¾ã—ãŸã€‚", "ok");
        } catch (err) {
          console.error(err);
          setStatus("ç”»åƒã‹ã‚‰ã®æ–‡å­—èª­ã¿å–ã‚Šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "warn");
        } finally {
          markOcrFile.value = "";
        }
      });

      async function doLoad(id) {
        if (!id) {
          setStatus("ã¾ãšæ¬å…¥ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "warn");
          return;
        }
        setStatus("èª­ã¿è¾¼ã¿ä¸­ã§ã™...", "");
        try {
          const record = await apiLoadRecord(id);
          if (record) {
            renderHeader(record.header || null);
            items = record.items || [];
            setStatus(`æ¬å…¥ç•ªå·ã€Œ${id}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`, "ok");
          } else {
            renderHeader(null);
            items = [];
            setStatus(
              `æ¬å…¥ç•ªå·ã€Œ${id}ã€ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦å…¥åŠ›ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚`,
              "ok"
            );
          }
          renderRowsList();
          updateTotals();
          clearRowForm();
          currentHainyuId = id;
          isDirty = false;
          updateEditingIndicator();
          saveBtn.disabled = false;
        } catch (e) {
          console.error(e);
          setStatus("ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "warn");
        }
      }

      loadBtn.addEventListener("click", () => {
        const id = hainyuInput.value.trim();
        doLoad(id);
      });

      // Enterã§èª­è¾¼
      hainyuInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const id = hainyuInput.value.trim();
          doLoad(id);
        }
      });

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆã§ã‚‚èª­è¾¼
      hainyuInput.addEventListener("change", () => {
        const id = hainyuInput.value.trim();
        if (!id) return;
        if (currentHainyuId === id && isDirty) return;
        doLoad(id);
      });

      // æ˜ç´°ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
      const pkgInput = document.getElementById("pkgInput");
      const noFromInput = document.getElementById("noFromInput");
      const noToInput = document.getElementById("noToInput");
      const qtyInput = document.getElementById("qtyInput");
      const lenInput = document.getElementById("lenInput");
      const widInput = document.getElementById("widInput");
      const heiInput = document.getElementById("heiInput");
      const weightInput = document.getElementById("weightInput");

      [pkgInput, noFromInput, noToInput, qtyInput, lenInput, widInput, heiInput, weightInput]
        .forEach((el) => {
          el.addEventListener("input", markDirty);
        });

      noFromInput.addEventListener("input", () => {
        updateQtyFromNos();
        updateRowM3Field();
      });
      noToInput.addEventListener("input", () => {
        updateQtyFromNos();
        updateRowM3Field();
      });
      qtyInput.addEventListener("input", () => {
        updateRowM3Field();
      });
      lenInput.addEventListener("input", updateRowM3Field);
      widInput.addEventListener("input", updateRowM3Field);
      heiInput.addEventListener("input", updateRowM3Field);

      // æ˜ç´°ã‚¯ãƒªã‚¢
      document.getElementById("rowClearBtn").addEventListener("click", () => {
        clearRowForm();
      });

      // æ˜ç´°è¿½åŠ /æ›´æ–°
      document.getElementById("rowSaveBtn").addEventListener("click", () => {
        const row = collectRowForm();
        if (!row) {
          setStatus("æ˜ç´°ã«ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "warn");
          return;
        }

        if (currentIndex === null) {
          items.push(row);
          setStatus("æ˜ç´°ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚", "ok");
        } else {
          items[currentIndex] = row;
          setStatus(`æ˜ç´° ${currentIndex + 1} ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`, "ok");
        }

        markDirty();
        renderRowsList();
        updateTotals();
        clearRowForm();
      });

      // ä¿å­˜
      saveBtn.addEventListener("click", async () => {
        const id = hainyuInput.value.trim();
        if (!id) {
          setStatus("æ¬å…¥ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "warn");
          return;
        }
        if (!items.length) {
          setStatus("ä¿å­˜ã™ã‚‹æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚1ä»¶ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "warn");
          return;
        }

        const header = collectHeader();
        if (!header.date) header.date = todayString();

        setStatus("ä¿å­˜ä¸­ã§ã™...", "");
        try {
          await apiSaveRecord(id, { header, items });
          currentHainyuId = id;
          isDirty = false;
          updateEditingIndicator();
          setStatus(`æ¬å…¥ç•ªå·ã€Œ${id}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, "ok");
        } catch (e) {
          console.error(e);
          setStatus("ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "warn");
        }
      });

      // URLã« ?id=XXXX ãŒã‚ã‚Œã°è‡ªå‹•èª­è¾¼
      const params = new URLSearchParams(window.location.search);
      const initialId = params.get("id");
      if (initialId) {
        hainyuInput.value = initialId;
        doLoad(initialId);
      }

      // æœªä¿å­˜ã§ãƒšãƒ¼ã‚¸é›¢è„±ã™ã‚‹æ™‚ã®è­¦å‘Š
      window.addEventListener("beforeunload", (e) => {
        if (!isDirty) return;
        e.preventDefault();
        e.returnValue = "";
      });
    });
  </script>
</body>
</html>
